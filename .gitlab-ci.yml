image: netanelgilad/yoshi-ci:node10

stages:
  - build
  - test

.use-node-modules-cache:
  before_script:
    - npm install --unsafe-perm
  cache:
    key: node_modules-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - packages/babel-preset-yoshi/node_modules/
      - packages/bootstrap-hot-loader/node_modules/
      - packages/create-yoshi-app/node_modules/
      - packages/eslint-config-yoshi/node_modules/
      - packages/eslint-config-yoshi-base/node_modules/
      - packages/jest-environment-yoshi-bootstrap/node_modules/
      - packages/jest-environment-yoshi-puppeteer/node_modules/
      - packages/jest-yoshi-preset/node_modules/
      - packages/tslint-config-yoshi/node_modules/
      - packages/tslint-config-yoshi-base/node_modules/
      - packages/yoshi/node_modules/
      - packages/yoshi-angular-dependencies/node_modules/
      - packages/yoshi-config/node_modules/
      - packages/yoshi-helpers/node_modules/
      - packages/yoshi-style-dependencies/node_modules/
    policy: pull

install:
  stage: build
  script: npm install --unsafe-perm
  cache:
    key: node_modules
    policy: push
    paths:
      - node_modules/
      - packages/babel-preset-yoshi/node_modules/
      - packages/bootstrap-hot-loader/node_modules/
      - packages/create-yoshi-app/node_modules/
      - packages/eslint-config-yoshi/node_modules/
      - packages/eslint-config-yoshi-base/node_modules/
      - packages/jest-environment-yoshi-bootstrap/node_modules/
      - packages/jest-environment-yoshi-puppeteer/node_modules/
      - packages/jest-yoshi-preset/node_modules/
      - packages/tslint-config-yoshi/node_modules/
      - packages/tslint-config-yoshi-base/node_modules/
      - packages/yoshi/node_modules/
      - packages/yoshi-angular-dependencies/node_modules/
      - packages/yoshi-config/node_modules/
      - packages/yoshi-helpers/node_modules/
      - packages/yoshi-style-dependencies/node_modules/

unit:
  extends: .use-node-modules-cache
  stage: test
  script: npm run test:unit

lint:
  extends: .use-node-modules-cache
  stage: test
  script: npm run lint

integration:
  extends: .use-node-modules-cache
  stage: test
  script: npm run test:integration

app-flow:
  extends: .use-node-modules-cache
  stage: test
  script: npm run test:app-flow

templates-client:
  extends: .use-node-modules-cache
  stage: test
  script: npm run test:templates:client

templates-fullstack:
  extends: .use-node-modules-cache
  stage: test
  script: npm run test:templates:fullstack

templates-business-manager-module:
  extends: .use-node-modules-cache
  stage: test
  script: npm run test:templates:business-manager-module

templates-server:
  extends: .use-node-modules-cache
  stage: test
  script: npm run test:templates:server
